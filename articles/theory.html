<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="portvine">
<title>Under the hood • portvine</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Under the hood">
<meta property="og:description" content="portvine">
<meta property="og:image" content="https://emanuelsommer.github.io/portvine/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">portvine</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/parallel.html">Parallel processing</a>
    <a class="dropdown-item" href="../articles/theory.html">Under the hood</a>
    <a class="dropdown-item" href="../articles/get_started.html">Get started</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/EmanuelSommer/portvine/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="theory_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Under the hood</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EmanuelSommer/portvine/blob/HEAD/vignettes/articles/theory.Rmd" class="external-link"><code>vignettes/articles/theory.Rmd</code></a></small>
      <div class="d-none name"><code>theory.Rmd</code></div>
    </div>

    
    
<p>This article will showcase <strong>what is going on under the hood</strong> of the <code>portvine</code> package. It will not contain any code so for a practical introduction on how to work with the package have a look at the <strong>Get Started</strong> vignette. At the end of this article one can find a mapping table from the theoretical notation to the function arguments in the <code>portvine</code> package. Note that this is just a package article so for a more rigorous and way more detailed explanation of the theory consult <a href="https://mediatum.ub.tum.de/1658240" class="external-link">Sommer (2022)</a>.</p>
<p>In order to discuss the theory some notation is needed. One has a portfolio <span class="math inline">\(\Omega\)</span> of <span class="math inline">\(d\)</span> assets <span class="math inline">\(A_j\)</span> with corresponding log returns <span class="math inline">\(r_t^{A_j}\)</span> for the time frame <span class="math inline">\(t = 1,\dots,T\)</span>. Additionally one has a weight of each asset in the portfolio denoted by <span class="math inline">\(w_j\)</span>. So one can write <span class="math inline">\(\Omega = \{w_j,r_t^{A_j}|t = 1,\dots,T;j=1,\dots,d\}\)</span>. Furthermore one has the hyperparameters</p>
<ul>
<li>
<span class="math inline">\(\Gamma &lt; T \in \mathbb{N}\)</span>: Length of the fitting window for the marginal models. Here one assumes that this is also the time index of the most recent asset return observation when starting the rolling window approach. So for the first marginal time series model one uses all the available historic data.</li>
<li>
<span class="math inline">\(\Psi \leq \Gamma \in \mathbb{N}\)</span>: Length of the fitting window for the vine copula model in order to capture dependencies.</li>
<li>
<span class="math inline">\(S \in \mathbb{N}\)</span>: : Number of to be simulated log returns for the risk measure estimation.</li>
</ul>
<p>Despite the final algorithms are performed in a rolling window fashion it is easier to grasp the one step ahead risk measure estimation which moves through the data according to the parameters introduced above as shown below.</p>
<p><br><img src="onestep_rm_estimate_onestepparams.png" align="center" width="100%"><br><br></p>
<p>The detailed <strong>unconditional one step ahead risk measure estimation</strong> is now shown.</p>
<p><br><img src="onestep_rm_estimate_uncond.png" align="center" width="100%"><br><br></p>
<p>This one step approach however requires a huge number of models to be fit in order to estimate the risk measures for even a smallish interval of interest like 50 trading days. Thus the rolling window approach with the following additional parameters is introduced.</p>
<ul>
<li>
<span class="math inline">\(\gamma \leq (T-\Gamma) \in \mathbb{N}\)</span>: Length of the forecasting window of the marginal models.</li>
<li>
<span class="math inline">\(\kappa \leq \gamma \in \mathbb{N}\)</span>: Length of the usage window of the vine copula model.</li>
</ul>
<p>It might be reasonable to pick them such that <span class="math inline">\((T-\Gamma) \text{ mod } \gamma \equiv 0\)</span> and one requires <span class="math inline">\(\gamma \text{ mod } \kappa \equiv 0\)</span>. An illustration of the parameters and the rolling of the respective windows of the rolling window approach can be found below.</p>
<p><br><img src="onestep_rm_estimate_rollparams.png" align="center" width="100%"><br><br></p>
<p>The full rolling window algorithm for unconditional risk measure estimation is stated in my master thesis to which I will link here as soon as it will be published. Now the <strong>single conditional risk measure estimation</strong> will be discussed with some additional notation.</p>
<ul>
<li>Market index <span class="math inline">\(I\)</span>: that is observed over the same time scale as the portfolio <span class="math inline">\(\Omega\)</span>, the log returns are again denoted by <span class="math inline">\(r_t^I\)</span>.</li>
<li>Let <span class="math inline">\(j_1,\dots,j_d\)</span> be a to be determined permutation of the indices of the assets <span class="math inline">\(1,\dots,d\)</span>.</li>
<li>
<span class="math inline">\(\alpha^I \in (0,1)\)</span>: Confidence level of the estimated quantile from the marginal market index distribution. This confidence level is the conditioning value for the final risk measure estimate on the copula scale. How this fits into the estimation process can be seen below.</li>
</ul>
<p>The approach is actually quite similar and is again illustrated for the <strong>one step ahead single conditional risk measure estimation</strong>.</p>
<p><br><img src="onestep_rm_estimate_cond.png" align="center" width="100%"><br><br></p>
<p>The ordering of the D-vine is calculated based on Pearson and partial correlations from the training data and aims to maximize the resulting full likelihood of the copula. An illustration of the estimated dependencies that are maximized in each step of the algorithm for a 4 dimensional example is given below.</p>
<p><br><img src="conddvine4colored.png" align="center" width="100%"><br><br></p>
<p>The <span class="math inline">\(c_{depth}\)</span> parameter can be used to only account for the dependencies up to the corresponding depth. More details can be once again found in my master thesis.</p>
<p>Additionally to this approach based on a quantile level one can also use the copula scale residual of the index <span class="math inline">\(I\)</span> from the prior time unit i.e. to estimate the risk measure at time unit <span class="math inline">\(t\)</span> use <span class="math inline">\(u^I_{t-1}\)</span> as the conditioning value at the copula scale. The resulting estimated risk measure will emulate the behavior of conditioning on the predicted market index log return series and might be a valuable comparison to the estimated quantile based conditional risk measures. Opposed to the <strong>quantile based conditional risk measures</strong> one will can call these <strong>prior residual conditional risk measures</strong>. These <code>prior_resid</code> risk measure estimates however suffer from exaggerating market fluctuations and thus should be handled with care. Another non quantile based conditional risk measure estimation approach is the one calculating the <strong>realized residual conditional risk measures</strong> which are based on the actual observed residuals which means one conditions on the actually realized value of the conditional asset. This is an oracle estimator as it suffers from information leakage but is a valuable comparison to the quantile based conditional risk measures. These <code>resid</code> risk measure estimates are calculated by default in the conditional case.</p>
<p>Extending the single conditional case to <strong>two conditioning market indices</strong> <span class="math inline">\(I_1, I_2\)</span> is quite straight forward. The only crucial change is to determine the conditioning values for the conditional sampling based on a quantile level <span class="math inline">\(\alpha^I\)</span>. This is achieved via the the bivariate copula fitted between the two market indices to adjust for their dependence. The ordering algorithm resulting in the order <span class="math inline">\(A_{j_d}-\dots- A_{j_1}-I_{\tilde{j}_1}-I_{\tilde{j}_2}\)</span> is conceptually equal to the one for a single market index. A detailed elaboration can be found in my master thesis. It is also there where the <strong>conditional sampling algorithms for D-vine copulas based on the rightmost leaf(s)</strong> were introduced. Moreover the thesis also theoretically elaborates on applicable backtesting strategies for the resulting portfolio level Value at Risk and expected shortfall estimates.</p>
<p>Finally a table is given that maps the function arguments to the now theoretically used variable names.</p>
<table style="width:99%;" class="table">
<colgroup>
<col width="31%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>Theoretical</th>
<th>Function</th>
<th>Argument</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>
<p><span class="math inline">\(\{r^{A_j}_t|t=1,\dot s,T;j = 1,\dots,d\}\)</span></p>
<p>and in the conditional case also the log returns of the conditioning assets e.g. <span class="math inline">\(r^I_t\)</span>.</p>
</td>
<td><code><a href="../reference/estimate_risk_roll.html">estimate_risk_roll()</a></code></td>
<td><code>data</code></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\{w_j|j=1,\dots,d\}\)</span></td>
<td><code><a href="../reference/estimate_risk_roll.html">estimate_risk_roll()</a></code></td>
<td><code>weights</code></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\Gamma\)</span></td>
<td><code><a href="../reference/marginal_settings-class.html">marginal_settings()</a></code></td>
<td><code>train_size</code></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\gamma\)</span></td>
<td><code><a href="../reference/marginal_settings-class.html">marginal_settings()</a></code></td>
<td><code>refit_size</code></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\Psi\)</span></td>
<td><code><a href="../reference/vine_settings-class.html">vine_settings()</a></code></td>
<td><code>train_size</code></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\kappa\)</span></td>
<td><code><a href="../reference/vine_settings-class.html">vine_settings()</a></code></td>
<td><code>refit_size</code></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(S\)</span></td>
<td><code><a href="../reference/estimate_risk_roll.html">estimate_risk_roll()</a></code></td>
<td><code>n_samples</code></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\alpha\)</span></td>
<td><code><a href="../reference/estimate_risk_roll.html">estimate_risk_roll()</a></code></td>
<td><code>alpha</code></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\widehat{RM}(\cdot)\)</span></td>
<td><code><a href="../reference/estimate_risk_roll.html">estimate_risk_roll()</a></code></td>
<td><code>risk_measures</code></td>
</tr>
<tr class="even">
<td>
<span class="math inline">\(I\)</span> or <span class="math inline">\(I_1,I_2\)</span>
</td>
<td><code><a href="../reference/estimate_risk_roll.html">estimate_risk_roll()</a></code></td>
<td><code>cond_vars</code></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\alpha^I\)</span></td>
<td><code><a href="../reference/estimate_risk_roll.html">estimate_risk_roll()</a></code></td>
<td><code>cond_u</code></td>
</tr>
<tr class="even">
<td><span class="math inline">\(c_{depth}\)</span></td>
<td><code><a href="../reference/estimate_risk_roll.html">estimate_risk_roll()</a></code></td>
<td><code>cutoff_depth</code></td>
</tr>
</tbody>
</table></main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Emanuel Sommer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
